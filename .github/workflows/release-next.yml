name: Release Next

# Manually publish @next releases for testing/preview
# Uses npm Trusted Publishers (OIDC) - no secrets required!
on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write # Required for npm Trusted Publishers (OIDC)

jobs:
  release-next:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - uses: nrwl/nx-set-shas@v4

      - name: Verify Quality (Lint, Test, Build)
        run: pnpm exec nx affected -t lint test build

      - name: Nx Report
        run: pnpm exec nx report

      - name: Release Next (Dry Run)
        if: ${{ inputs.dry_run == true }}
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          NEXT_VERSION="0.0.0-next.$SHA_SHORT"
          echo "ðŸ” Dry run - would release version: $NEXT_VERSION"
          pnpm exec nx release version $NEXT_VERSION --git-commit=false --git-tag=false --stage-changes=false
          pnpm exec nx release publish --tag=next --dry-run

      - name: Release Next
        if: ${{ inputs.dry_run != true }}
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          NEXT_VERSION="0.0.0-next.$SHA_SHORT"
          echo "ðŸ“¦ Releasing version: $NEXT_VERSION"

          # Version without git operations
          pnpm exec nx release version $NEXT_VERSION --git-commit=false --git-tag=false --stage-changes=false

          # Publish to npm with next tag (uses OIDC)
          pnpm exec nx release publish --tag=next
        # No NODE_AUTH_TOKEN needed - uses OIDC via Trusted Publishers!

      - name: Summary
        run: |
          SHA_SHORT=$(git rev-parse --short HEAD)
          echo "## Release Next Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Version: 0.0.0-next.$SHA_SHORT" >> $GITHUB_STEP_SUMMARY
          echo "- npm Tag: next" >> $GITHUB_STEP_SUMMARY
          echo "- Dry Run: ${{ inputs.dry_run || false }}" >> $GITHUB_STEP_SUMMARY
          echo "- Auth: npm Trusted Publishers (OIDC)" >> $GITHUB_STEP_SUMMARY
